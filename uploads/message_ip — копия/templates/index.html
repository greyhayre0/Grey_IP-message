<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ß–∞—Ç</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
<p>IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞: {{ ip }}</p>
<div id="container">
    <!-- –§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ -->
    <div id="file-section">
        <h4>–û–±—â–µ–µ —Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</h4>
        <div id="drop-area">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</div>
        <input type="file" id="file-input" style="display:none;" />
        <button id="upload-btn" class="button">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</button>
        <div id="file-list"></div>
        <div id="pagination">
            <button class="page-btn" id="prev-page">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <span id="page-info"></span>
            <button class="page-btn" id="next-page">–°–ª–µ–¥—É—é—â–∞—è</button>
        </div>
    </div>
    <!-- –ß–∞—Ç -->
    <div id="chat-section">
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
            <button id="send-btn" class="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>
<script>
    let currentPage = 1;
    const perPage = 20;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function loadMessages() {
        fetch('/get_messages')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('messages');
                const scrollBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;

                container.innerHTML = '';
                data.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'message ' + (msg.sender === '{{ ip }}' ? 'user' : 'bot');
                    div.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text}`;
                    container.appendChild(div);
                });
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑, –µ—Å–ª–∏ –±—ã–ª–æ –≤–Ω–∏–∑—É
                if (scrollBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
    function loadFiles() {
        fetch(`/list_files?page=${currentPage}&per_page=${perPage}`)
            .then(res => res.json())
            .then(data => {
                const listDiv = document.getElementById('file-list');
                listDiv.innerHTML = '';
                data.items.forEach(item => {
                    const link = document.createElement('a');
                    if (item.is_dir) {
                        link.href = '#';
                        link.onclick = () => {
                            alert('–ü–∞–ø–∫–∏ –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è.');
                        };
                    } else {
                        link.href = `/uploads/${item.name}`;
                        link.target = '_blank';
                    }
                    link.className = 'file-link message';

                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'file-icon';
                    iconSpan.innerHTML = 'üìÑ';

                    link.innerHTML = '';
                    link.appendChild(iconSpan);
                    const textSpan = document.createElement('span');
                    textSpan.textContent = item.name;
                    link.appendChild(textSpan);

                    listDiv.appendChild(link);
                });
                document.getElementById('page-info').textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${data.total_pages}`;
            });
    }

    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadFiles();
        }
    });
    document.getElementById('next-page').addEventListener('click', () => {
        fetch(`/list_files?page=${currentPage + 1}&per_page=${perPage}`)
            .then(res => res.json())
            .then(data => {
                if (data.items.length > 0) {
                    currentPage++;
                    loadFiles();
                }
            });
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('send-btn').addEventListener('click', () => {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (text === '') return;
        fetch('/send_message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        }).then(res => res.json())
          .then(() => {
            input.value = '';
            loadMessages(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        });
    });
    document.getElementById('message-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('send-btn').click();
        }
    });
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∞–π–ª–∞
    document.getElementById('upload-btn').addEventListener('click', () => {
        document.getElementById('file-input').click();
    });
    document.getElementById('file-input').addEventListener('change', () => {
        handleFileUpload();
    });
    const dropArea = document.getElementById('drop-area');
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.add('dragover');
        });
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('dragover');
        });
    });
    dropArea.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });

    function handleFileUpload(file) {
        if (!file) {
            file = document.getElementById('file-input').files[0];
            if (!file) return;
        }
        let filename = file.name;
        const extIndex = filename.lastIndexOf('.');
        const ext = extIndex !== -1 ? filename.slice(extIndex) : '';
        const namePart = extIndex !== -1 ? filename.slice(0,extIndex) : filename;

        const truncatedName = namePart.length > 10 ? namePart.slice(0,10) : namePart;
        filename = truncatedName + ext;

        const newFile = new File([file], filename, { type: file.type });
        const formData = new FormData();
        formData.append('file', newFile);
        fetch('/upload', {
            method: 'POST',
            body: formData
        }).then(res => res.json())
          .then(data => {
            alert(data.message);
            loadFiles();
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
        loadMessages();
        loadFiles();
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Ñ–∞–π–ª–æ–≤ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        setInterval(() => {
            loadMessages();
            loadFiles();
        }, 3000);
    }
    init();
</script>
</body>
</html>